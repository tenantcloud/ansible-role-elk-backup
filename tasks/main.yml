---
  - name: Install elasticsearch repository-s3 plugin
    elasticsearch_plugin:
      name: repository-s3
      state: present
      force: yes
  - name: Copy elk scripts
    copy:
      src: files/elk
      dest: /usr/local/bin

  - name: Add cron job for backup index
    shell: echo '10 3 * * * ubuntu /usr/local/bin/backup-elk `date --date='-1 day' +%Y.%m.%d` > /dev/null 2>&1' | sudo tee -a /etc/crontab
    args:
      executable: /bin/bash

   - name: Add cron job to remove last index for 31 day
     shell: echo '20 3 * * * ubuntu /usr/local/bin/elk-delete `date --date='-31 day' +%Y.%m.%d` > /dev/null 2>&1' | sudo tee -a /etc/crontab
     args:
       executable: /bin/bash

   - name: Copy elk environment
     template:
       src: files/env/.elk.example
       dest: /usr/local/bin/.elk
